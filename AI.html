<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shopping Assistant - Amazon Clone</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* Animated Background Particles */
      #particles {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
      }

      .particle {
        position: absolute;
        width: 4px;
        height: 4px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        animation: float 8s infinite linear;
      }

      @keyframes float {
        0% {
          transform: translateY(100vh) rotate(0deg);
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          transform: translateY(-100px) rotate(360deg);
          opacity: 0;
        }
      }

      /* Main Content */
      .main-content {
        position: relative;
        z-index: 2;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
        text-align: center;
      }

      .welcome-section {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 40px;
        max-width: 600px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .welcome-section h1 {
        color: white;
        font-size: 2.5rem;
        margin-bottom: 20px;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      .welcome-section p {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1.2rem;
        line-height: 1.6;
        margin-bottom: 30px;
      }

      .feature-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .feature-card {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: transform 0.3s ease;
      }

      .feature-card:hover {
        transform: translateY(-5px);
      }

      .feature-card h3 {
        color: #ffeb3b;
        margin-bottom: 10px;
        font-size: 1.3rem;
      }

      .feature-card p {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
      }

      /* Floating Chat Icon */
      .chat-icon {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 70px;
        height: 70px;
        background: linear-gradient(135deg, #ff6b6b, #ff8e53);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        z-index: 1000;
        transition: all 0.3s ease;
        animation: pulse 2s infinite;
      }

      .chat-icon:hover {
        transform: scale(1.1);
        box-shadow: 0 12px 35px rgba(255, 107, 107, 0.6);
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .chat-icon svg {
        width: 35px;
        height: 35px;
        fill: white;
      }

      /* Chat Container */
      .chat-container {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 400px;
        height: 600px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        transform: translateY(100%) scale(0.8);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        z-index: 1001;
        overflow: hidden;
      }

      .chat-container.open {
        transform: translateY(0) scale(1);
        opacity: 1;
      }

      /* Chat Header */
      .chat-header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        padding: 20px;
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .chat-header h3 {
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .close-chat {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: background 0.3s ease;
      }

      .close-chat:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      /* Messages Area */
      .messages {
        height: 420px;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
      }

      .messages::-webkit-scrollbar {
        width: 6px;
      }

      .messages::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      .messages::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 10px;
      }

      .message {
        margin-bottom: 15px;
        display: flex;
        align-items: flex-start;
        gap: 10px;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.user {
        flex-direction: row-reverse;
      }

      .message .bubble {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.4;
        position: relative;
      }

      .message.user .bubble {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-bottom-right-radius: 6px;
      }

      .message.bot .bubble {
        background: white;
        color: #333;
        border: 1px solid #e1e8ed;
        border-bottom-left-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .bot-avatar {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #ff6b6b, #ff8e53);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .bot-avatar svg {
        width: 18px;
        height: 18px;
        fill: white;
      }

      /* Enhanced Product Card Styles */
      .product-card {
        background: #fff;
        border: 1px solid #e1e8ed;
        border-radius: 12px;
        padding: 12px;
        margin: 8px 0;
        display: flex;
        gap: 12px;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .product-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }

      .product-image {
        width: 60px;
        height: 60px;
        background: #f0f0f0;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: #666;
        position: relative;
        flex-shrink: 0;
      }

      .discount-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #ff4757;
        color: white;
        font-size: 10px;
        padding: 2px 4px;
        border-radius: 4px;
        font-weight: bold;
      }

      .product-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .product-info h4 {
        font-size: 13px;
        color: #333;
        margin: 0;
        font-weight: 600;
        line-height: 1.3;
      }

      .product-brand {
        font-size: 11px;
        color: #666;
        margin: 0;
      }

      .product-price {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: bold;
        font-size: 14px;
        color: #ff6b6b;
      }

      .original-price {
        font-size: 12px;
        color: #999;
        text-decoration: line-through;
        font-weight: normal;
      }

      .product-details {
        display: flex;
        flex-direction: column;
        gap: 2px;
        font-size: 11px;
      }

      .stock-status {
        font-weight: 500;
      }

      .stock-status.in-stock {
        color: #2ed573;
      }

      .stock-status.out-stock {
        color: #ff4757;
      }

      .colors,
      .sizes {
        color: #666;
      }

      .view-product-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 11px;
        cursor: pointer;
        margin-top: 4px;
        transition: all 0.3s ease;
        align-self: flex-start;
      }

      .view-product-btn:hover {
        background: linear-gradient(135deg, #5a67d8, #6b46c1);
        transform: translateY(-1px);
      }

      .loading-products {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      .error-message {
        background: #ffe6e6;
        color: #d63031;
        padding: 10px;
        border-radius: 8px;
        font-size: 12px;
        margin: 8px 0;
      }

      /* Typing Indicator */
      .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 8px 0;
      }

      .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #667eea;
        animation: typing 1.5s infinite;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          transform: scale(1);
          opacity: 0.7;
        }
        30% {
          transform: scale(1.3);
          opacity: 1;
        }
      }

      /* Chat Input */
      .chat-input {
        padding: 20px;
        border-top: 1px solid #e1e8ed;
        background: white;
      }

      .input-container {
        display: flex;
        gap: 10px;
        align-items: flex-end;
      }

      .image-preview {
        display: none;
        margin-bottom: 10px;
        position: relative;
      }

      .image-preview img {
        max-width: 80px;
        max-height: 80px;
        border-radius: 8px;
        border: 2px solid #e1e8ed;
      }

      .remove-image {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #ff4757;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .input-group {
        flex: 1;
        position: relative;
      }

      .chat-input input {
        width: 100%;
        padding: 12px 45px 12px 15px;
        border: 2px solid #e1e8ed;
        border-radius: 25px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.3s ease;
      }

      .chat-input input:focus {
        border-color: #667eea;
      }

      .attach-btn {
        position: absolute;
        right: 45px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        color: #667eea;
        padding: 5px;
      }

      .send-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .send-btn:hover {
        transform: scale(1.1);
      }

      .send-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .send-btn svg {
        width: 20px;
        height: 20px;
        fill: white;
      }

      .rate-limit-msg {
        color: #ff4757;
        font-size: 12px;
        text-align: center;
        margin-top: 8px;
        display: none;
      }

      /* Mobile Responsive */
      @media (max-width: 480px) {
        .chat-container {
          width: calc(100vw - 20px);
          height: calc(100vh - 40px);
          right: 10px;
          bottom: 10px;
        }

        .welcome-section {
          padding: 20px;
          margin: 10px;
        }

        .welcome-section h1 {
          font-size: 2rem;
        }

        .feature-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Animated Background -->
    <div id="particles"></div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="welcome-section">
        <h1>üõçÔ∏è Amazon Shopping Assistant</h1>
        <p>
          Your AI-powered shopping companion is here to help! Get personalized
          product recommendations, compare prices, and find exactly what you're
          looking for.
        </p>

        <div class="feature-grid">
          <div class="feature-card">
            <h3>üîç Smart Search</h3>
            <p>
              Describe what you want and your budget - get tailored
              recommendations instantly
            </p>
          </div>
          <div class="feature-card">
            <h3>üì∏ Image Search</h3>
            <p>
              Upload a photo and find similar products across our entire catalog
            </p>
          </div>
          <div class="feature-card">
            <h3>üí∞ Budget Helper</h3>
            <p>
              Set your budget and discover the best deals within your price
              range
            </p>
          </div>
          <div class="feature-card">
            <h3>‚≠ê Quality Picks</h3>
            <p>
              Get recommendations based on ratings, reviews, and customer
              satisfaction
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating Chat Icon -->
    <div class="chat-icon" id="chatIcon">
      <svg viewBox="0 0 24 24">
        <path
          d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM8 14H6v-2h2v2zm0-3H6V9h2v2zm0-3H6V6h2v2zm7 6h-2v-2h2v2zm0-3h-2V9h2v2zm0-3h-2V6h2v2z"
        />
      </svg>
    </div>

    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
      <!-- Chat Header -->
      <div class="chat-header">
        <h3>
          <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
            <path
              d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
            />
          </svg>
          Shopping Assistant
        </h3>
        <button class="close-chat" id="closeChat">&times;</button>
      </div>

      <!-- Messages Area -->
      <div class="messages" id="messages">
        <div class="message bot">
          <div class="bot-avatar">
            <svg viewBox="0 0 24 24">
              <path
                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
              />
            </svg>
          </div>
          <div class="bubble">
            Hi! I'm your shopping assistant! üõçÔ∏è<br /><br />
            You can:
            <br />‚Ä¢ Tell me what you're looking for with your budget <br />‚Ä¢
            Upload an image to find similar products <br />‚Ä¢ Ask for
            recommendations in any category<br /><br />
            What can I help you find today?
          </div>
        </div>
      </div>

      <!-- Chat Input -->
      <div class="chat-input">
        <div class="image-preview" id="imagePreview">
          <img id="previewImg" alt="Preview" />
          <button class="remove-image" id="removeImage">&times;</button>
        </div>

        <form id="chatForm">
          <div class="input-container">
            <div class="input-group">
              <input
                type="text"
                id="userInput"
                placeholder="Describe what you're looking for..."
                autocomplete="off"
              />
              <button type="button" class="attach-btn" id="attachBtn">
                <svg
                  viewBox="0 0 24 24"
                  width="20"
                  height="20"
                  fill="currentColor"
                >
                  <path
                    d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"
                  />
                </svg>
              </button>
            </div>
            <button type="submit" class="send-btn" id="sendBtn">
              <svg viewBox="0 0 24 24">
                <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" />
              </svg>
            </button>
          </div>
        </form>

        <div class="rate-limit-msg" id="rateLimitMsg"></div>
        <input
          type="file"
          id="imageInput"
          accept="image/*"
          style="display: none"
        />
      </div>
    </div>

    <script>
      // Server API endpoints - adjust these URLs to match your server setup
      const API_ENDPOINTS = {
        search: "/api/products/search",
        imageSearch: "/api/products/image-search",
        chat: "/api/chat/message",
      };

      // --- Animated Background particles ---
      function createParticles() {
        const particles = document.getElementById("particles");
        for (let i = 0; i < 30; i++) {
          const particle = document.createElement("div");
          particle.className = "particle";
          particle.style.left = Math.random() * 100 + "%";
          particle.style.top = Math.random() * 100 + "%";
          particle.style.animationDelay = Math.random() * 8 + "s";
          particle.style.animationDuration = Math.random() * 3 + 5 + "s";
          particles.appendChild(particle);
        }
      }

      // --- Chat State ---
      const messagesDiv = document.getElementById("messages");
      const sendBtn = document.getElementById("sendBtn");
      const rateLimitMsg = document.getElementById("rateLimitMsg");
      const chatIcon = document.getElementById("chatIcon");
      const chatContainer = document.getElementById("chatContainer");
      const closeChat = document.getElementById("closeChat");
      const imageInput = document.getElementById("imageInput");
      const attachBtn = document.getElementById("attachBtn");
      const imagePreview = document.getElementById("imagePreview");
      const previewImg = document.getElementById("previewImg");
      const removeImage = document.getElementById("removeImage");
      const chatForm = document.getElementById("chatForm");
      const userInput = document.getElementById("userInput");

      let chatHistory = [];
      let lastSentTimes = [];
      let attachedImageData = null;
      const RATE_LIMIT = 5;
      const RATE_WINDOW = 30 * 1000;

      // --- Server Communication Functions ---
      async function searchProductsOnServer(
        query,
        budget = null,
        imageData = null
      ) {
        try {
          const requestData = {
            query: query,
            budget: budget,
            imageData: imageData,
            limit: 5,
          };

          const endpoint = imageData
            ? API_ENDPOINTS.imageSearch
            : API_ENDPOINTS.search;

          const response = await fetch(endpoint, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify(requestData),
          });

          if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
          }

          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Server search error:", error);
          throw error;
        }
      }

      async function sendChatMessage(message, imageData = null) {
        try {
          const requestData = {
            message: message,
            imageData: imageData,
            conversationId: sessionStorage.getItem("conversationId") || null,
          };

          const response = await fetch(API_ENDPOINTS.chat, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify(requestData),
          });

          if (!response.ok) {
            throw new Error(`Chat API error: ${response.status}`);
          }

          const data = await response.json();

          // Store conversation ID for context
          if (data.conversationId) {
            sessionStorage.setItem("conversationId", data.conversationId);
          }

          return data;
        } catch (error) {
          console.error("Chat API error:", error);
          throw error;
        }
      }

      function extractBudgetFromQuery(query) {
        const budgetMatch = query.match(
          /\$(\d+)|(\d+)\s*dollars?|budget.*?(\d+)|under.*?(\d+)/i
        );
        if (budgetMatch) {
          return parseFloat(
            budgetMatch[1] || budgetMatch[2] || budgetMatch[3] || budgetMatch[4]
          );
        }
        return null;
      }

      function createProductCard(product) {
        // Calculate discount percentage if available
        const hasDiscount =
          product.discount_price && product.discount_price < product.price;
        const discountPercent = hasDiscount
          ? Math.round(
              ((product.price - product.discount_price) / product.price) * 100
            )
          : 0;

        // Get the first image or use placeholder
        const imageUrl =
          product.product_images && product.product_images.length > 0
            ? product.product_images[0].image_url
            : "/images/placeholder-product.jpg";

        // Format price display
        const originalPrice = product.price
          ? `${product.price.toFixed(2)}`
          : "Price not available";
        const displayPrice = hasDiscount
          ? `${product.discount_price.toFixed(2)}`
          : originalPrice;

        // Stock status
        const stockStatus =
          product.stock_quantity > 0
            ? `${product.stock_quantity} in stock`
            : "Out of stock";

        return `
              <div class="product-card" data-product-id="${product.id}">
                  <div class="product-image">
                      <img src="${imageUrl}" alt="${
          product.name
        }" style="width:60px;height:60px;object-fit:cover;border-radius:8px;"
                           onerror="this.src='/images/placeholder-product.jpg'">
                      ${
                        hasDiscount
                          ? `<div class="discount-badge">-${discountPercent}%</div>`
                          : ""
                      }
                  </div>
                  <div class="product-info">
                      <h4>${product.name}</h4>
                      <p class="product-brand">${
                        product.Brand || "Generic Brand"
                      }</p>
                      <div class="product-price">
                          ${displayPrice}
                          ${
                            hasDiscount
                              ? `<span class="original-price">${product.price.toFixed(
                                  2
                                )}</span>`
                              : ""
                          }
                      </div>
                      <div class="product-details">
                          <span class="stock-status ${
                            product.stock_quantity > 0
                              ? "in-stock"
                              : "out-stock"
                          }">${stockStatus}</span>
                          ${
                            product.Colors
                              ? `<span class="colors">Colors: ${product.Colors}</span>`
                              : ""
                          }
                          ${
                            product.Sizes
                              ? `<span class="sizes">Sizes: ${product.Sizes}</span>`
                              : ""
                          }
                      </div>
                      <button class="view-product-btn" onclick="viewProduct('${
                        product.id
                      }')">View Details</button>
                  </div>
              </div>
          `;
      }

      // Function to handle product detail view
      function viewProduct(productId) {
        // This would typically redirect to product detail page
        window.open(`/products/${productId}`, "_blank");
      }

      // --- Utility Functions ---
      function addMessage(role, content, imageData) {
        const msgDiv = document.createElement("div");
        msgDiv.className = "message " + (role === "user" ? "user" : "bot");

        let imageHtml = "";
        if (imageData) {
          imageHtml = `<img src="${imageData}" style="max-width:120px;max-height:120px;border-radius:12px;margin-bottom:8px;" />`;
        }

        if (role === "bot") {
          msgDiv.innerHTML = `
                  <div class="bot-avatar">
                      <svg viewBox="0 0 24 24">
                          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                      </svg>
                  </div>
                  <div class="bubble">
                      ${imageHtml}
                      <span>${content}</span>
                  </div>
              `;
        } else {
          msgDiv.innerHTML = `
                  <div class="bubble">
                      ${imageHtml}
                      <span>${content}</span>
                  </div>
              `;
        }

        messagesDiv.appendChild(msgDiv);
        setTimeout(() => {
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }, 100);
      }

      function showTyping() {
        const typingDiv = document.createElement("div");
        typingDiv.className = "message bot typing";
        typingDiv.id = "typingIndicator";
        typingDiv.innerHTML = `
              <div class="bot-avatar">
                  <svg viewBox="0 0 24 24">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
              </div>
              <div class="bubble">
                  <div class="typing-indicator">
                      <div class="typing-dot"></div>
                      <div class="typing-dot"></div>
                      <div class="typing-dot"></div>
                  </div>
              </div>
          `;
        messagesDiv.appendChild(typingDiv);
        setTimeout(() => {
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }, 100);
      }

      function removeTyping() {
        const typingDiv = document.getElementById("typingIndicator");
        if (typingDiv) typingDiv.remove();
      }

      function showRateLimit(msg) {
        rateLimitMsg.textContent = msg;
        rateLimitMsg.style.display = "block";
      }

      function hideRateLimit() {
        rateLimitMsg.style.display = "none";
      }

      // --- Rate Limiting ---
      function canSend() {
        const now = Date.now();
        lastSentTimes = lastSentTimes.filter((t) => now - t < RATE_WINDOW);
        return lastSentTimes.length < RATE_LIMIT;
      }

      function recordSend() {
        lastSentTimes.push(Date.now());
      }

      // --- Image Attachment Logic ---
      attachBtn.addEventListener("click", () => {
        imageInput.click();
      });

      imageInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = function (evt) {
            attachedImageData = evt.target.result;
            previewImg.src = attachedImageData;
            imagePreview.style.display = "block";
          };
          reader.readAsDataURL(file);
        } else {
          attachedImageData = null;
          imagePreview.style.display = "none";
          previewImg.src = "";
        }
      });

      removeImage.addEventListener("click", () => {
        attachedImageData = null;
        imagePreview.style.display = "none";
        previewImg.src = "";
        imageInput.value = "";
      });

      // --- Local Product Search Logic ---
      function handleLocalSearch(userMsg) {
        const budget = extractBudgetFromQuery(userMsg);
        const products = searchProducts(userMsg, budget);

        if (products.length > 0) {
          let response = budget
            ? `Great! I found ${products.length} products within your $${budget} budget:\n\n`
            : `Here are some great options I found for you:\n\n`;

          const productCards = products
            .map((product) => createProductCard(product))
            .join("");
          response += productCards;

          response += `\n\nWould you like me to search for more options or help you with something else?`;
          return response;
        } else {
          return budget
            ? `I couldn't find any products matching your criteria within your ${budget} budget. Try adjusting your search terms or increasing your budget.`
            : `I couldn't find any products matching your search. Could you try different keywords or be more specific about what you're looking for?`;
        }
      }

      // --- Chat Logic ---
      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        hideRateLimit();

        if (!canSend()) {
          showRateLimit(
            "You're sending messages too quickly. Please wait a few seconds..."
          );
          sendBtn.disabled = true;
          setTimeout(() => {
            sendBtn.disabled = false;
            hideRateLimit();
          }, 3000);
          return;
        }

        const userMsg = userInput.value.trim();
        if (!userMsg && !attachedImageData) return;

        addMessage("user", userMsg, attachedImageData);

        // First try local search for product queries
        if (
          userMsg &&
          !attachedImageData &&
          (userMsg.toLowerCase().includes("jacket") ||
            userMsg.toLowerCase().includes("budget") ||
            userMsg.toLowerCase().includes("looking for") ||
            userMsg.toLowerCase().includes("need") ||
            userMsg.toLowerCase().includes("want") ||
            userMsg.toLowerCase().includes("find") ||
            userMsg.toLowerCase().includes("search"))
        ) {
          const localResponse = handleLocalSearch(userMsg);
          setTimeout(() => {
            addMessage("bot", localResponse);
          }, 500);

          userInput.value = "";
          attachedImageData = null;
          imagePreview.style.display = "none";
          previewImg.src = "";
          imageInput.value = "";
          return;
        }

        // Prepare message for AI API
        let userMessageObj;
        if (attachedImageData) {
          userMessageObj = {
            role: "user",
            content: [
              ...(userMsg
                ? [
                    {
                      type: "text",
                      text: `As a shopping assistant for an Amazon-like store, help the user find products. Here's their message: ${userMsg}`,
                    },
                  ]
                : [
                    {
                      type: "text",
                      text: "As a shopping assistant, please help me find products similar to this image. What products would you recommend?",
                    },
                  ]),
              { type: "image_url", image_url: { url: attachedImageData } },
            ],
          };
        } else {
          userMessageObj = {
            role: "user",
            content: `As a shopping assistant for an Amazon-like store, please help with this request: ${userMsg}. Provide helpful product recommendations and shopping advice.`,
          };
        }
        chatHistory.push(userMessageObj);

        userInput.value = "";
        sendBtn.disabled = true;
        recordSend();

        // Clear image preview after sending
        attachedImageData = null;
        imagePreview.style.display = "none";
        previewImg.src = "";
        imageInput.value = "";

        showTyping();

        try {
          let payload = {
            model: "meta-llama/llama-3.1-70b-versatile",
            messages: [
              {
                role: "system",
                content:
                  "You are a helpful shopping assistant for an Amazon-like e-commerce platform. Help users find products, compare prices, and make informed purchasing decisions. Be friendly, knowledgeable, and provide specific product recommendations when possible. If users mention a budget, respect it. If they upload images, help them find similar products.",
              },
              ...chatHistory,
            ],
            max_tokens: 1000,
            temperature: 0.7,
          };

          const response = await fetch(
            "https://api.groq.com/openai/v1/chat/completions",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization:
                  "Bearer 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",
              },
              body: JSON.stringify(payload),
            }
          );

          removeTyping();

          if (!response.ok) {
            const errorData = await response.json();
            console.error("API Error:", errorData);
            addMessage(
              "bot",
              "Sorry, I'm having trouble connecting to my knowledge base right now. Let me try to help you with our local product database instead!"
            );

            // Fallback to local search if API fails
            if (userMsg) {
              const localResponse = handleLocalSearch(userMsg);
              setTimeout(() => {
                addMessage("bot", localResponse);
              }, 1000);
            }
            sendBtn.disabled = false;
            return;
          }

          const data = await response.json();
          const botMsg =
            data.choices?.[0]?.message?.content ||
            "Sorry, I didn't understand that. Could you please rephrase your request?";

          addMessage("bot", botMsg);
          chatHistory.push({ role: "assistant", content: botMsg });
        } catch (err) {
          removeTyping();
          console.error("Network Error:", err);
          addMessage(
            "bot",
            "I'm having network issues. Let me search our local database for you instead!"
          );

          // Fallback to local search on network error
          if (userMsg) {
            const localResponse = handleLocalSearch(userMsg);
            setTimeout(() => {
              addMessage("bot", localResponse);
            }, 1000);
          }
        }
        sendBtn.disabled = false;
      });

      // --- Floating Icon and Chat Window Logic ---
      chatIcon.addEventListener("click", () => {
        chatContainer.classList.add("open");
        chatIcon.style.display = "none";
        setTimeout(() => userInput.focus(), 300);
      });

      closeChat.addEventListener("click", () => {
        chatContainer.classList.remove("open");
        chatIcon.style.display = "block";
      });

      // --- Initialize ---
      window.onload = () => {
        createParticles();
        if (chatContainer.classList.contains("open")) {
          userInput.focus();
        }
      };

      // --- Enhanced Examples ---
      setTimeout(() => {
        if (!chatContainer.classList.contains("open")) {
          // Add some example interactions to show capabilities
          const examples = [
            "Try: 'I need a black leather jacket under $100'",
            "Try: 'Show me gaming keyboards'",
            "Try: Upload an image and ask 'Find similar products'",
          ];

          console.log("Shopping Assistant Ready!");
          console.log("Example queries:", examples);
        }
      }, 2000);
    </script>
  </body>
</html>
